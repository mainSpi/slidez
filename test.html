<script type="text/javascript" src="/scripts/pdf-lib.js"></script>
<script type="text/javascript" src="/scripts/pdf-download.js"></script>
<script src="/scripts/pdf.mjs" type="module"></script>

<script>

    const {PDFDocument, rgb, degrees, PageSizes} = PDFLib;

    async function embedImages() {
        const jpgUrl = '/images/cat_riding_unicorn.jpg';

        const jpgImageBytes = await fetch(jpgUrl).then((res) => res.arrayBuffer());

        const pdfDoc = await PDFDocument.create();

        const embeddedJpg = await pdfDoc.embedJpg(jpgImageBytes);

        const jpgDims = embeddedJpg.scale(0.5);

        const oddPage = await pdfDoc.addPage([embeddedJpg.width, embeddedJpg.height]);

        await oddPage.drawImage(embeddedJpg, {
            // x: page.getWidth() / 2 - jpgDims.width / 2,
            // y: page.getHeight() / 2 - jpgDims.height / 2 + 250,
            // width: jpgDims.width,
            // height: jpgDims.height,
        });


        // oddly shaped page that needs to be fitted to an a4 sized one.
        const a4Page = await pdfDoc.addPage(PageSizes.A4);

        let angle = 90 * Math.PI / 180;

        // let mat1 = [[a, b, 0],
        //             [c, d, 0],
        //             [e, f, 1]]

        // [1 0 0 1 tx ty]
        //  a b c d  e  f
        //[sx 0 0 sy 0  0]

        /*
        [
            Math.cos(angle),
            Math.sin(angle),
            -1 * Math.sin(angle),
            Math.cos(angle),
            0,
            0,
        ]
         */

        let scale = 0.620083;
        let xCenter = a4Page.getWidth() / 2;
        let yCenter = a4Page.getHeight() / 2;

        let mati = [[1, 0, 0],
            [0, 1, 0],
            [0, 0, 1]];

        let matScale = [[scale, 0, 0],
            [0, scale, 0],
            [0, 0, 1]];

        let matMove = [[1, 0, 0],
            [0, 1, 0],
            [xCenter, yCenter, 1]];

        let matRotate = [[Math.cos(angle), Math.sin(angle), 0],
            [-1 * Math.sin(angle), Math.cos(angle), 0],
            [0, 0, 1]];

        let matMoveBack = [[1, 0, 0],
            [0, 1, 0],
            [-1 * (yCenter), -1 * xCenter, 1]];

        let matPosCorrection = [[1, 0, 0],
            [0, 1, 0],
            [-100, -100, 1]];

        let finalMat = multiplyMatrices([matMove, matRotate, matMoveBack]);

        const embOddPage = await pdfDoc.embedPage(oddPage, {
                left: oddPage.getWidth(), right: 0, top: oddPage.getHeight(), bottom: 0
            }, matrixToArray(finalMat)
        );

        let fx = Math.abs(PageSizes.A4[0] / embOddPage.width);
        let fy = Math.abs(PageSizes.A4[1] / embOddPage.height);

        let newScale = fx >= fy ? fy : fx;
        console.log(newScale);
        // let embOddPageDims = await embOddPage.scale(newScale);
        let embOddPageDims = await embOddPage.size();
        console.log(embOddPageDims);

        a4Page.drawPage(embOddPage, {
            width: -960,
            height: 540,
            x: 100,
            y: 0,
            // x: a4Page.getWidth() / 2 - embOddPageDims.width / 2,
            // y: a4Page.getHeight() / 2 - embOddPageDims.height / 2,
        });

        const pdfBytes = await pdfDoc.save();
        download(pdfBytes, 'test.pdf', "application/pdf");
    }

    // This function multiplies
    // mat1[][] and mat2[][], and
    // stores the result in res[][]
    function multiplyMatrices(matArray) {
        function multiply(mat1, mat2) {
            let res = new Array(3);
            let i, j, k;
            for (i = 0; i < 3; i++) {
                res[i] = new Array(3);
                for (j = 0; j < 3; j++) {
                    res[i][j] = 0;
                    for (k = 0; k < 3; k++)
                        res[i][j] += mat1[i][k] * mat2[k][j];
                }
            }
            return res;
        }


        let array = Array.from(matArray);
        let runningMatrix = array[0];
        for (let i = 1; i < array.length; i++) {
            runningMatrix = multiply(array[i], runningMatrix);
        }
        return runningMatrix;

    }


    // this returns [a, b, c, d, e, f] ignoring everything else
    function matrixToArray(matrix) {
        let array = [];
        array.push(matrix[0][0]);
        array.push(matrix[0][1]);
        array.push(matrix[1][0]);
        array.push(matrix[1][1]);
        array.push(matrix[2][0]);
        array.push(matrix[2][1]);
        return array;
    }

    embedImages();

</script>